@startuml Infractructure Deployment
' C4-PlantUML: Deployment
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Deployment.puml

LAYOUT_TOP_DOWN()
title Интернет-магазин — Infrastructure / Deployment

Person(user, "Пользователь интернета", "Покупатель/продавец/администратор работает через веб-интерфейс")

' NOTE: assumed default for missing ADR: фронтенд раздаётся через CDN + объектное хранилище — типичный и простой способ хостинга SPA/Next.js для учебного проекта.
Boundary(pub, "Публичный интернет") {

  Deployment_Node(cdn, "CDN + статический хостинг фронтенда", "CDN + объектное хранилище (S3-совместимое)", "Раздача SPA, edge-кэширование, базовая защита (DDoS/WAF на уровне провайдера)") {
    Container(frontend, "Фронтенд (SPA)", "TypeScript, React, Next.js", "Веб-приложение + админ-панель")
  }

  Boundary(ext, "Внешние сервисы") {
    System_Ext(pay_ext, "Платёжная система", "Внешняя обработка онлайн-платежей и возвратов")
    System_Ext(delivery_ext, "Служба доставки", "Внешний сервис логистики и статусов доставки")
    System_Ext(notify_ext, "Внешняя система уведомлений", "Email/SMS/Push через сторонний провайдер")
  }
}

Boundary(priv, "Частная сеть (VPC/кластерная сеть)") {

  ' NOTE: assumed default for missing ADR: TLS-терминация на внешнем балансировщике/Ingress — стандартная практика для Kubernetes и упрощает управление сертификатами.
  Deployment_Node(entry, "Точка входа в API", "Load Balancer + Ingress", "TLS-терминация, маршрутизация в API Gateway, базовые политики безопасности (лимиты/фильтры)") {
    Container(api_gw, "API Gateway", "Envoy Proxy", "Маршрутизация, балансировка, безопасность, rate limiting")
  }

  Deployment_Node(k8s, "Кластер Kubernetes", "Kubernetes (Docker)", "Развертывание микросервисов") {

    Deployment_Node(ns_backend, "Зона: Backend", "Kubernetes", "") {
      Container(auth, "Сервис аутентификации (Auth)", "Kotlin, Spring Boot", "OAuth 2.0 / OIDC, JWT, роли")
      Container(catalog, "Сервис каталога (Catalog)", "Kotlin, Spring Boot", "Каталог: поиск, фильтрация, карточки товаров")
      Container(orders, "Сервис заказов (Order)", "Kotlin, Spring Boot", "Корзина и заказы: создание, статусы, история")
      Container(payments, "Сервис платежей (Payment)", "Kotlin, Spring Boot", "Платежи/возвраты, интеграция с платёжной системой")
      Container(reco, "Сервис рекомендаций (Recommendation)", "Kotlin, Spring Boot", "Рекомендации по истории просмотров/покупок")
      Container(notify, "Сервис уведомлений (Notification)", "Kotlin, Spring Boot", "Отправка уведомлений через внешние сервисы")

      Container(workers, "Фоновые воркеры", "Kotlin, Spring Boot", "Отложенные вычисления/конвейеры: обновление статистики, пересчёт рейтингов, генерация отчётов, обработка изображений, интеграции с внешними API, инвалидация/пересчёт кэшей по событиям")
    }

    Deployment_Node(async, "Асинхронная обработка", "RabbitMQ", "Брокер сообщений") {
      Container(queue, "RabbitMQ", "Erlang", "Очереди/события для фоновой обработки")
    }
  }

  ' NOTE: assumed default for missing ADR: слой данных вынесен из Kubernetes как managed-сервисы в той же VPC — это упрощает эксплуатацию и соответствует типовой практике.
  Deployment_Node(data, "Слой данных", "PostgreSQL / Elasticsearch / Redis (managed)", "Полиглотное хранение") {
    ContainerDb(pg_primary, "PostgreSQL: primary", "PostgreSQL", "Транзакционные данные (пользователи/заказы/платежи/каталог/отзывы/рекомендации)")
    ContainerDb(pg_repl, "PostgreSQL: read replicas (x2)", "PostgreSQL", "Чтение (учитывать задержку репликации)")
    ContainerDb(es_search, "Elasticsearch (поиск)", "Elasticsearch", "Поисковый индекс каталога")
    ContainerDb(redis, "Redis", "Redis", "Кэш (страницы/поиск), сессии, корзины")
  }

  Deployment_Node(obs, "Наблюдаемость", "Prometheus / Grafana / ELK", "") {
    Container(prom, "Prometheus", "Go", "Сбор метрик производительности и доступности")
    Container(graf, "Grafana", "Go", "Дашборды/визуализация метрик")
    Container(elk, "ELK Stack", "Elasticsearch, Logstash, Kibana", "Централизованное логирование и анализ")
  }

  note right of entry
    TLS-терминация: на внешнем балансировщике/Ingress (узел «Точка входа в API»).
    Защита от DDoS/WAF: на уровне edge (CDN) и/или балансировщика (типовые managed-возможности провайдера).
    Rate limiting: в API Gateway (Envoy) как первая линия защиты от перегрузки API.
  end note

  note right of data
    Размещение слоя данных: выделенный сегмент в частной сети (managed-сервисы), доступ только из VPC/кластера.
    Read replicas: 2 реплики для масштабирования чтения.
    Бэкапы и retention (DUR01):
    - PostgreSQL: ежедневный pg_dump, хранение 7 дней в объектном хранилище.
    - Elasticsearch: ежедневные snapshots через Snapshot API, хранение 7 дней в объектном хранилище.
    - Redis: AOF (для восстановления после рестарта) + ежедневный RDB-снимок, хранение 3 дня.
    Failover (DUR02):
    - PostgreSQL: автоматическое переключение primary (managed-механизм; типовой аналог — Patroni).
    - Elasticsearch/Redis: автоматическое восстановление/перезапуск на уровне managed-кластера.
  end note
}

' --- Основной пользовательский поток ---
Rel(user, frontend, "Открывает интерфейс интернет-магазина", "HTTPS")
Rel(frontend, entry, "Запросы к API (в т.ч. с JWT после логина)", "HTTPS")
Rel(entry, api_gw, "Проксирование запросов в кластер", "HTTPS")

' --- Маршрутизация в микросервисы через API Gateway ---
Rel(api_gw, auth, "Маршрутизация /api/auth", "HTTP/gRPC")
Rel(api_gw, catalog, "Маршрутизация /api/catalog", "HTTP/gRPC")
Rel(api_gw, orders, "Маршрутизация /api/orders", "HTTP/gRPC")
Rel(api_gw, payments, "Маршрутизация /api/payments", "HTTP/gRPC")
Rel(api_gw, reco, "Маршрутизация /api/recommendations", "HTTP/gRPC")
Rel(api_gw, notify, "Маршрутизация /api/notifications", "HTTP/gRPC")

' --- Аутентификация/токены ---
Rel(frontend, api_gw, "Логин/обновление токенов через API", "HTTPS")

' NOTE: assumed default for missing ADR: refresh tokens храним в БД в виде хэшей и ротируем при использовании — это распространённая практика для повышения безопасности.
Rel(auth, frontend, "Выдаёт JWT (15 мин) + refresh token (30 дней); refresh token хранится в PostgreSQL как хэш, ротация при обновлении", "HTTPS")
Rel(auth, api_gw, "Публикует публичные ключи (JWKS) для проверки JWT и состав claims/ролей", "Конфигурация/HTTPS")

' --- Доступ к данным (CP: запись в primary, чтение с replica) ---
' NOTE: assumed default for missing ADR: автоматический failover реализован managed-кластером (или Patroni-подобным оркестратором) — стандарт для PostgreSQL в HA-схемах.
Rel(pg_primary, pg_repl, "Репликация (primary → replica); автоматическое переключение primary при сбое", "PostgreSQL replication")

Rel(auth, pg_primary, "Запись пользователей/ролей", "JDBC")
Rel(auth, pg_repl, "Чтение пользователей/ролей", "JDBC")

Rel(orders, pg_primary, "Запись заказов/корзин", "JDBC")
Rel(orders, pg_repl, "Чтение заказов/истории", "JDBC")

Rel(payments, pg_primary, "Запись статусов оплаты/возвратов", "JDBC")
Rel(payments, pg_repl, "Чтение статусов/истории", "JDBC")

Rel(catalog, pg_primary, "Запись данных каталога (в т.ч. атрибуты в JSONB)", "JDBC")
Rel(catalog, pg_repl, "Чтение данных каталога", "JDBC")
Rel(catalog, es_search, "Индексация/поиск", "Elasticsearch API")
Rel(catalog, redis, "Кэширование каталога/поиска", "Redis client")

Rel(orders, redis, "Кэширование корзины", "Redis client")

' NOTE: assumed default for missing ADR: модель рекомендаций основана на событиях взаимодействия пользователя с товаром (просмотр/покупка/оценка) в простой событийной таблице.
Rel(reco, pg_primary, "Запись истории взаимодействий (таблица user_events: view/purchase/rating)", "JDBC")
Rel(reco, pg_repl, "Чтение истории для рекомендаций", "JDBC")
Rel(reco, redis, "Кэширование рекомендаций", "Redis client")

' --- Асинхронная обработка (очередь + фоновые воркеры/консьюмеры) ---
Rel(orders, queue, "Публикует события домена", "AMQP")
Rel(payments, queue, "Публикует события домена", "AMQP")
Rel(catalog, queue, "Публикует события домена", "AMQP")
Rel(queue, notify, "Доставка событий для отправки уведомлений", "AMQP")
Rel(queue, reco, "Доставка событий для обновления рекомендаций", "AMQP")
Rel(queue, workers, "Доставка событий для фоновых задач", "AMQP")

' --- Внешние интеграции ---
Rel(payments, pay_ext, "Платежи/возвраты", "API/HTTPS")
Rel(orders, delivery_ext, "Передача заказов и получение статусов доставки", "API/HTTPS")
Rel(notify, notify_ext, "Отправка email/SMS/push", "API/HTTPS")

' --- Метрики и логи ---
Rel(auth, prom, "Экспорт метрик", "HTTP")
Rel(catalog, prom, "Экспорт метрик", "HTTP")
Rel(orders, prom, "Экспорт метрик", "HTTP")
Rel(payments, prom, "Экспорт метрик", "HTTP")
Rel(reco, prom, "Экспорт метрик", "HTTP")
Rel(notify, prom, "Экспорт метрик", "HTTP")
Rel(prom, graf, "Визуализация метрик", "HTTP")

Rel(auth, elk, "Отправка логов", "HTTP")
Rel(catalog, elk, "Отправка логов", "HTTP")
Rel(orders, elk, "Отправка логов", "HTTP")
Rel(payments, elk, "Отправка логов", "HTTP")
Rel(reco, elk, "Отправка логов", "HTTP")
Rel(notify, elk, "Отправка логов", "HTTP")
Rel(workers, elk, "Отправка логов", "HTTP")

SHOW_LEGEND()
@enduml
