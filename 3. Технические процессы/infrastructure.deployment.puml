@startuml Infrastructure Deployment
title Infrastructure Deployment — Интернет-магазин

skinparam componentStyle rectangle
skinparam shadowing false
skinparam wrapWidth 200

' =========================================================
' ПОЛЬЗОВАТЕЛИ
' =========================================================
actor "Покупатель" as user
actor "Продавец / Администратор" as admin

' =========================================================
' КЛИЕНТСКИЙ УРОВЕНЬ
' =========================================================
rectangle "Клиентские приложения" {
  [Веб-приложение\n(React + Next.js)] as web
  [Админ-панель\n(React + Next.js)] as admin_ui
}

user --> web
admin --> admin_ui

' =========================================================
' ИНФРАСТРУКТУРА (НАШЕ ПРИЛОЖЕНИЕ)
' =========================================================
rectangle "Инфраструктура" {

  rectangle "Kubernetes кластер" {

    [API Gateway\n(Шлюз API)] as gateway

    rectangle "Бизнес-сервисы" {
      [Сервис аутентификации] as auth
      [Сервис каталога] as catalog
      [Сервис поиска] as search
      [Сервис заказов] as orders
      [Сервис оплаты] as payment
      [Сервис продавцов] as seller_svc
      [Сервис отзывов] as reviews
      [Сервис уведомлений] as notify
      [Сервис рекомендаций] as recs
    }

    queue "RabbitMQ\n(очередь сообщений)" as mq
  }
}

web --> gateway
admin_ui --> gateway

gateway --> auth
gateway --> catalog
gateway --> search
gateway --> orders
gateway --> payment
gateway --> seller_svc
gateway --> reviews
gateway --> notify
gateway --> recs

' =========================================================
' ХРАНИЛИЩА ДАННЫХ
' =========================================================
rectangle "Хранилища данных" {

  database "PostgreSQL\n(основные данные)" as pg
  database "Elasticsearch\n(поиск)" as es
  database "Redis\n(кэш и сессии)" as redis
}

catalog --> pg
orders --> pg
payment --> pg
seller_svc --> pg
reviews --> pg
auth --> pg

search --> es
catalog --> mq
orders --> mq
mq --> search
mq --> notify
mq --> recs

gateway --> redis
catalog --> redis
search --> redis

' =========================================================
' ВНЕШНИЕ СЕРВИСЫ
' =========================================================
rectangle "Внешние сервисы" {

  cloud "Платёжный провайдер" as ext_pay
  cloud "Email / SMS провайдер" as ext_msg
  cloud "OAuth-провайдер\n(социальная авторизация)" as ext_oauth
  cloud "Сервис доставки" as ext_ship
  cloud "Объектное хранилище\n(изображения товаров)" as ext_s3
}

payment --> ext_pay : оплата / статус
notify --> ext_msg : email / sms
auth --> ext_oauth : OAuth
orders --> ext_ship : расчёт доставки / трекинг
catalog --> ext_s3 : загрузка изображений

' =========================================================
' ПОДДЕРЖКА
' =========================================================
rectangle "Поддержка и эксплуатация" {
  [Сервис резервного копирования] as backup
  [Мониторинг и логирование] as mon
}

backup --> pg
backup --> es

gateway --> mon
orders --> mon
payment --> mon

' =========================================================
' ПОЯСНЕНИЯ
' =========================================================
note right of gateway
  Единая точка входа:
  - маршрутизация запросов
  - единый API для клиентов
end note

note right of mq
  Асинхронное взаимодействие:
  - обновление поиска
  - уведомления
  - рекомендации
end note

note left of ext_s3
  Внешнее хранилище:
  - изображения товаров
  - снижает нагрузку на БД
end note

@enduml
